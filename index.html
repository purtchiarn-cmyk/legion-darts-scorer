<!-- Due to character limits, the full code is too long to paste in one message. I'll break it into parts. -->

<!-- PART 1: HTML Structure and Styles -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Legion Darts Scorer v3.0</title>
<style>
  /* Styles remain mostly unchanged, but include responsive tweaks and space for checkout helper */
  :root {
    --bg: #f5f9ff;
    --fg: #003366;
    --accent: #007bff;
    --card: #ffffff;
  }
  body.dark {
    --bg: #0d1117;
    --fg: #e6edf3;
    --accent: #58a6ff;
    --card: #161b22;
  }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--fg);
    margin: 0;
    text-align: center;
    transition: background 0.3s, color 0.3s;
  }
  #startScreen, #gameScreen {
    max-width: 480px;
    margin: auto;
    padding: 1rem;
  }
  #gameScreen {
    display: none;
    opacity: 0;
    transition: opacity 0.5s;
  }
  .card {
    background: var(--card);
    border-radius: 10px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input {
    padding: 0.5rem;
    width: 80%;
    margin: 0.3rem 0;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    padding: 0.8rem;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
  }
  #scoreboard {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
  }
  .player {
    flex: 1 1 45%;
    margin: 0.5rem;
    padding: 0.5rem;
    border-radius: 8px;
  }
  .player.active {
    background: rgba(0,123,255,0.1);
  }
  .score {
    font-size: 2.2rem;
    margin: 0.3rem 0;
  }
  .checkout {
    font-size: 0.9rem;
    color: var(--accent);
    margin-bottom: 0.5rem;
  }
  .avg {
    font-size: 0.9rem;
    color: var(--accent);
  }
  #keypad {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .dart-row {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 0.5rem 0;
  }
  .dart {
    width: 2.2rem;
    height: 2.2rem;
    line-height: 2.2rem;
    border-radius: 5px;
    background: var(--card);
    border: 1px solid #ccc;
  }
  #controls {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-top: 0.8rem;
  }
  #darkToggle {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--card);
    color: var(--fg);
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
  }
  #message {
    font-weight: bold;
    margin-top: 0.5rem;
    display: none;
  }
  #matchHistory {
    display: none;
    position: fixed;
    top: 10%;
    left: 10%;
    right: 10%;
    background: var(--card);
    border: 2px solid var(--accent);
    padding: 1rem;
    z-index: 10;
    border-radius: 10px;
    max-height: 80%;
    overflow-y: auto;
  }
</style>
</head>
<body>
<button id="darkToggle">‚òÄÔ∏è</button>

<!-- START SCREEN -->
<div id="startScreen" class="card">
  <h1>üéØ Legion Darts Scorer</h1>
  <input id="homeName" placeholder="Home Player Name"><br>
  <input id="awayName" placeholder="Away Player Name"><br>
  <label>Best of: <input id="bestOf" type="number" min="1" max="9" value="3" style="width:50px"></label><br><br>
  <button id="startGame">Start Game</button>
  <p style="margin-top:1rem;font-size:0.8rem;">Version v3.0</p>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
  <div id="scoreboard" class="card">
    <div class="player active" id="home">
      <h2>Home (P1)</h2>
      <div class="score" id="score1">501</div>
      <div class="checkout" id="checkout1"></div>
      <div class="avg" id="avg1">3DA: 0.00</div>
      <div class="dart-row" id="darts1">
        <div class="dart empty">‚Äì</div><div class="dart empty">‚Äì</div><div class="dart empty">‚Äì</div>
      </div>
    </div>
    <div class="player" id="away">
      <h2>Away (P2)</h2>
      <div class="score" id="score2">501</div>
      <div class="checkout" id="checkout2"></div>
      <div class="avg" id="avg2">3DA: 0.00</div>
      <div class="dart-row" id="darts2">
        <div class="dart empty">‚Äì</div><div class="dart empty">‚Äì</div><div class="dart empty">‚Äì</div>
      </div>
    </div>
  </div>

  <div id="keypad" class="card">
    <button data-action="D">D</button>
    <button data-action="T">T</button>
    <button data-action="25">25</button>
    <button data-action="BULL">Bull</button>
    <button data-action="NS">No Score</button>

    <button>1</button><button>2</button><button>3</button><button>4</button><button>5</button>
    <button>6</button><button>7</button><button>8</button><button>9</button><button>10</button>
    <button>11</button><button>12</button><button>13</button><button>14</button><button>15</button>
    <button>16</button><button>17</button><button>18</button><button>19</button><button>20</button>
  </div>

  <div id="controls">
    <button id="statsBtn">üìä</button>
    <button id="undoDart">‚Ü©Ô∏è Dart</button>
    <button id="undoTurn">‚Ü©Ô∏è Turn</button>
    <button id="undoLast">‚Ü©Ô∏è Prev</button>
  </div>

  <button id="submitTurn" style="margin-top:0.8rem;width:90%;max-width:400px;">Submit Turn</button>
  <div id="message"></div>
</div>

<!-- MATCH HISTORY OVERLAY -->
<div id="matchHistory" class="card"></div>

<script>
// ---------- DARK MODE ----------
const darkToggle = document.getElementById('darkToggle');
darkToggle.onclick = () => {
  document.body.classList.toggle('dark');
  darkToggle.textContent = document.body.classList.contains('dark') ? 'üåô' : '‚òÄÔ∏è';
};

// ---------- GAME STATE ----------
let matchState = {
  legsToWin: 2,
  legsWon: [0, 0],
  currentLeg: 1,
  scores: [501, 501],
  currentDarts: [[], []],
  allDarts: [[], []],
  active: 0,
  legHistory: []
};

const scoreEls = [document.getElementById('score1'), document.getElementById('score2')];
const dartEls = [document.getElementById('darts1'), document.getElementById('darts2')];
const avgEls = [document.getElementById('avg1'), document.getElementById('avg2')];
const checkoutEls = [document.getElementById('checkout1'), document.getElementById('checkout2')];
const msg = document.getElementById('message');

// ---------- START GAME ----------
document.getElementById('startGame').onclick = () => {
  const homeName = document.getElementById('homeName').value || 'Home';
  const awayName = document.getElementById('awayName').value || 'Away';
  matchState.legsToWin = parseInt(document.getElementById('bestOf').value);
  document.querySelector('#home h2').textContent = `${homeName} (P1)`;
  document.querySelector('#away h2').textContent = `${awayName} (P2)`;
  document.getElementById('startScreen').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    document.getElementById('gameScreen').style.opacity = '1';
  }, 500);
};

// ---------- UTILS ----------
function showMessage(text) {
  msg.textContent = text;
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 1500);
}

function updateDarts() {
  for (let i = 0; i < 2; i++) {
    const dset = dartEls[i].querySelectorAll('.dart');
    dset.forEach((d, j) => {
      d.textContent = matchState.currentDarts[i][j] !== undefined ? matchState.currentDarts[i][j] : '‚Äì';
      d.classList.toggle('empty', matchState.currentDarts[i][j] === undefined);
    });
  }
}

function switchPlayer() {
  document.getElementById('home').classList.toggle('active');
  document.getElementById('away').classList.toggle('active');
  matchState.active = 1 - matchState.active;
}

function calcStats(i) {
  const darts = matchState.allDarts[i];
  if (!darts.length) return '3DA: 0.00';
  const total = darts.reduce((a, b) => a + b, 0);
  const avg = (total / darts.length * 3).toFixed(2);
  const highest = Math.max(...darts.map((_, idx) => {
    if (idx % 3 !== 0) return 0;
    return darts.slice(idx, idx + 3).reduce((a, b) => a + b, 0);
  }));
  return `3DA: ${avg} | Darts: ${darts.length} | Total: ${total} | High: ${highest}`;
}

function updateCheckout(i) {
  const score = matchState.scores[i];
  const table = {
    170: 'T20 T20 Bull', 167: 'T20 T19 Bull', 164: 'T20 T18 Bull',
    161: 'T20 T17 Bull', 160: 'T20 T20 D20', 158: 'T20 T20 D19',
    157: 'T20 T19 D20', 156: 'T20 T20 D18', 155: 'T20 T19 D19',
    154: 'T20 T18 D20', 153: 'T20 T19 D18', 152: 'T20 T20 D16',
    151: 'T20 T17 D20', 150: 'T20 T18 D18', 149: 'T20 T19 D16',
    148: 'T20 T16 D20', 147: 'T20 T17 D18', 146: 'T20 T18 D16',
    145: 'T20 T15 D20', 144: 'T20 T20 D12', 143: 'T20 T17 D16',
    142: 'T20 T14 D20', 141: 'T20 T19 D12', 140: 'T20 T20 D10',
    139: 'T20 T13 D20', 138: 'T20 T18 D12', 137: 'T20 T15 D16',
    136: 'T20 T20 D8', 135: 'T20 T17 D12', 134: 'T20 T14 D16',
    133: 'T20 T19 D8', 132: 'T20 T16 D12

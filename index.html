<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Legion Darts Scorer v2.4</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6fbff; --panel:#ffffff;
  --lightBlue:#dff3ff; --accent:#1e88ff; --accent-2:#0b66ff;
  --muted:#6b7a86; --danger:#d64545; --green:#1f8a4c; --gold:#d4af37;
  --section-gap:1.2rem; --inner-gap:0.6rem;
  --fast:0.28s; --slow:0.8s;
  font-family: "Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#f8fcff,#eef8ff);color:#072028}
.app{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column;padding:12px;gap:var(--section-gap);}

/* --- top 30% (scores & stats) --- */
.top {
  display:flex; gap:12px; align-items:start; justify-content:space-between;
  height:28%;
}
.player {
  background:var(--panel); flex:1; padding:10px; border-radius:14px; box-shadow:0 6px 20px rgba(3,50,90,0.06); position:relative;
  display:flex; flex-direction:column; align-items:flex-start; min-width:0;
}
.player + .player { margin-left:8px }
.player h3{margin:0;font-size:14px;color:var(--accent-2);font-weight:600}
.score{font-size:34px;font-weight:700;color:var(--accent);margin:8px 0}
.darts-row{display:flex;gap:8px;margin-top:6px}
.dart-chip{min-width:58px;padding:8px;border-radius:10px;background:#f3fbff;border:1px solid rgba(11,102,255,0.06);text-align:center;font-weight:700;cursor:pointer}
.dart-chip.empty{opacity:0.45}
.dart-val{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}
.threeDA{position:absolute;right:10px;top:10px;font-weight:700;font-size:12px}
.threeDA.inactive{color:#9aa4ae}
.player.active{box-shadow:0 14px 36px rgba(11,102,255,0.12);border:1px solid rgba(11,102,255,0.06); animation:pulse 1.6s infinite}
@keyframes pulse{0%{box-shadow:0 8px 20px rgba(11,102,255,0.08);}50%{box-shadow:0 16px 40px rgba(11,102,255,0.12);}100%{box-shadow:0 8px 20px rgba(11,102,255,0.08);}}

/* stats button top-right */
.stats-btn{position:relative}
.stats-btn button{position:absolute;right:0;top:-6px;border-radius:10px;padding:6px 8px;border:0;background:linear-gradient(180deg,var(--lightBlue),#fff);color:var(--accent-2);font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(11,102,255,0.06)}

/* --- middle 50% (5x5 keypad) --- */
.middle{height:52%;display:flex;flex-direction:column;gap:10px}
.darts-labels{display:flex;gap:8px;justify-content:center;align-items:center}
.darts-labels .label{font-weight:700;color:var(--muted);font-size:13px;display:flex;gap:8px;align-items:center}
.grid {
  display:grid; grid-template-columns:repeat(5,1fr); gap:8px; flex:1;
}
.btn {
  background:var(--panel); border:0;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;
  box-shadow:0 6px 18px rgba(3,50,90,0.04); font-size:16px;
}
.btn:active{transform:translateY(1px)}
.btn.special{background:linear-gradient(180deg,#f8fbff,#eaf8ff); color:var(--accent-2)}
.btn.no-score { background: linear-gradient(180deg,#fff7f7,#fff0f0); color:var(--muted) }

/* --- bottom 20% (controls) --- */
.bottom { height:20%; display:flex; align-items:center; }
.controls{display:flex;gap:8px;width:100%}
.ctrl-btn{flex:1;padding:12px;border-radius:12px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
.ctrl-btn.ghost{background:#fff;border:1px solid rgba(3,50,90,0.06);color:var(--accent-2)}

/* modal / overlay */
.modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;z-index:120}
.modal{background:var(--panel);padding:16px;border-radius:12px;width:88%;max-width:420px;animation:fadeIn var(--slow) ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14vh;padding:10px 14px;background:rgba(2,8,23,0.8);color:white;border-radius:10px;z-index:200;opacity:0;transition:opacity .4s}
.toast.show{opacity:1}

/* floating label for last dart */
.float-label{position:fixed;left:50%;transform:translateX(-50%);top:36%;background:rgba(255,255,255,0.98);padding:8px 12px;border-radius:10px;color:#072028;font-weight:700;box-shadow:0 10px 30px rgba(2,8,23,0.16);z-index:220;opacity:0;transition:opacity var(--fast)}
.float-label.show{opacity:1}

/* small responsive tweak */
@media (max-height:700px){
  .top{height:26%}
  .middle{height:56%}
  .bottom{height:18%}
}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- TOP: Scores & per-dart chips -->
  <div class="top">
    <div class="player active" id="player-home" aria-live="polite">
      <h3 id="name-home">Home (P1)</h3>
      <div class="score" id="score-home">501</div>
      <div class="darts-row" id="chips-home">
        <div class="dart-chip empty" data-index="0">D1</div>
        <div class="dart-chip empty" data-index="1">D2</div>
        <div class="dart-chip empty" data-index="2">D3</div>
      </div>
      <div class="dart-val" id="vals-home" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
      <div class="threeDA" id="3da-home">3DA: 0.00</div>
    </div>

    <div class="player" id="player-away" aria-live="polite">
      <h3 id="name-away">Away (P2)</h3>
      <div class="score" id="score-away">501</div>
      <div class="darts-row" id="chips-away">
        <div class="dart-chip empty" data-index="0">D1</div>
        <div class="dart-chip empty" data-index="1">D2</div>
        <div class="dart-chip empty" data-index="2">D3</div>
      </div>
      <div class="dart-val" id="vals-away" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
      <div class="threeDA inactive" id="3da-away">3DA: 0.00</div>
    </div>

    <div class="stats-btn" aria-hidden="false">
      <button id="open-stats" title="Stats">ðŸ“Š</button>
    </div>
  </div>

  <!-- MIDDLE: Dart grid (5x5) -->
  <div class="middle">
    <div class="darts-labels" style="justify-content:center">
      <div class="label">Dart 1</div>
      <div class="label">Dart 2</div>
      <div class="label">Dart 3</div>
    </div>

    <div class="grid" id="grid">
      <!-- Col 1 special column then numbers across columns 2-5 in row-major order -->
      <button class="btn special" data-action="double">D</button>
      <button class="btn" data-num="1">1</button>
      <button class="btn" data-num="2">2</button>
      <button class="btn" data-num="3">3</button>
      <button class="btn" data-num="4">4</button>

      <button class="btn special" data-action="treble">T</button>
      <button class="btn" data-num="5">5</button>
      <button class="btn" data-num="6">6</button>
      <button class="btn" data-num="7">7</button>
      <button class="btn" data-num="8">8</button>

      <button class="btn special" data-action="25">25</button>
      <button class="btn" data-num="9">9</button>
      <button class="btn" data-num="10">10</button>
      <button class="btn" data-num="11">11</button>
      <button class="btn" data-num="12">12</button>

      <button class="btn special" data-action="bull">Bull</button>
      <button class="btn" data-num="13">13</button>
      <button class="btn" data-num="14">14</button>
      <button class="btn" data-num="15">15</button>
      <button class="btn" data-num="16">16</button>

      <button class="btn no-score" data-action="noscore">No Score</button>
      <button class="btn" data-num="17">17</button>
      <button class="btn" data-num="18">18</button>
      <button class="btn" data-num="19">19</button>
      <button class="btn" data-num="20">20</button>
    </div>
  </div>

  <!-- BOTTOM: Controls -->
  <div class="bottom">
    <div class="controls">
      <button id="coin" class="ctrl-btn ghost">ðŸª™</button>
      <button id="undo-dart" class="ctrl-btn ghost">Undo Dart</button>
      <button id="undo-turn" class="ctrl-btn ghost">Undo This Turn</button>
      <button id="undo-last" class="ctrl-btn ghost">Undo Last Player</button>
      <button id="submit" class="ctrl-btn">Submit Turn</button>
    </div>
  </div>
</div>

<!-- Stats modal (fade-in centered) -->
<div class="modal-back" id="modal" role="dialog" aria-modal="true">
  <div class="modal">
    <button id="close" style="float:right;border:0;background:none;font-size:20px;cursor:pointer">âœ–</button>
    <h3 style="margin-top:0">Stats (current leg)</h3>
    <div id="stats-content" style="text-align:left;color:#0b2b34"></div>
  </div>
</div>

<div class="float-label" id="floatLabel" aria-hidden="true"></div>
<div class="toast" id="toast"></div>

<script>
/*
  Legion Darts Scorer v2.4 JS
  - Implements the UX from your sketch:
    top: scores + per-dart chips + 3DA
    middle: 5x5 entry grid (D, T, 25, Bull, No Score; numbers)
    bottom: coin | undo dart | undo turn | undo last player | submit
  - Per-dart editing, max 3 darts, No Score counts, bust hold, floating label, stats modal (pauses).
*/

/* ---------- State ---------- */
const START = 501;
let state = {
  players: [
    { name: 'Home (P1)', score: START, dartsThrown: 0, highestCheckout: 0 },
    { name: 'Away (P2)', score: START, dartsThrown: 0, highestCheckout: 0 }
  ],
  current: 0,                // 0 = home, 1 = away
  staged: [[], []],          // staged darts this turn per player (but we use only staged[current] actively)
  history: [],               // confirmed turns {player, startScore, darts, newScore, turnTotal, bust, legIndex}
  perLegHistory: [],         // optional aggregated per-leg (not used heavily here)
  doubleOut: true,           // league rule default (kept but not exposed in UI here)
  pendingMultiplier: null,   // 'double' or 'treble' or null
  savedAt: null
};

const STORAGE_KEY = 'legion:scorer:v2.4';
/* try resume if saved */
(function loadSaved(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ const s = JSON.parse(raw); if(s) Object.assign(state, s); }
  }catch(e){}
})();

/* ---------- DOM refs ---------- */
const el = id => document.getElementById(id);
const playerEls = [el('player-home'), el('player-away')];
const scoreEls = [el('score-home'), el('score-away')];
const chipsEls = [el('chips-home'), el('chips-away')];
const valsEls = [el('vals-home'), el('vals-away')];
const avgEls = [el('3da-home'), el('3da-away')];
const modal = el('modal'), statsBtn = el('open-stats'), closeModal = el('close'), statsContent = el('stats-content');
const floatLabel = el('floatLabel'), toast = el('toast');

/* ---------- Helpers ---------- */
function save(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); state.savedAt = Date.now(); }catch(e){}
}
function toastShow(text, ms=1200){ toast.textContent = text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show') }, ms); }

/* compute 3DA from history (confirmed turns) */
function compute3DAFor(playerIndex){
  let pts = 0, darts = 0;
  state.history.forEach(h=>{
    if(h.player === playerIndex){
      if(h.bust) darts += h.darts.length;
      else { darts += h.darts.length; pts += h.turnTotal; }
    }
  });
  if(darts === 0) return 0.0;
  return (pts / darts) * 3;
}

/* compute first-9 average for current leg (from history with legIndex = current leg) */
function computeFirst9(playerIndex){
  // we consider history entries for the current leg (legIndex = current leg number = sum of legs completed)
  const currentLegIndex = computeCurrentLegIndex();
  // gather darts thrown by player in this leg in sequence and compute first 9 darts value
  let dartsSeq = [];
  state.history.forEach(h=>{
    if(h.legIndex === currentLegIndex && h.player === playerIndex && !h.bust){
      h.darts.forEach(d => dartsSeq.push(d.val));
    }
    if(h.legIndex === currentLegIndex && h.player === playerIndex && h.bust){
      // bust darts count as thrown but zero points counted for that turn
      h.darts.forEach(() => dartsSeq.push(0));
    }
  });
  // also include staged darts for convenience (not yet submitted) for current player
  if(state.current === playerIndex){
    state.staged[playerIndex].forEach(d => dartsSeq.push(d.val));
  }
  // take first 9 darts
  const first9 = dartsSeq.slice(0,9);
  if(first9.length === 0) return 0.0;
  const sum = first9.reduce((a,b) => a + b, 0);
  const avg3 = (sum / first9.length) * 3;
  return avg3;
}

function computeCurrentLegIndex(){
  // legIndex is how many legs have been completed so far (count legWon entries in history)
  let idx = 0;
  state.history.forEach(h=>{ if(h.legWon) idx++; });
  return idx;
}

/* update UI rendering */
function render(){
  // scores
  scoreEls[0].textContent = Math.max(0, state.players[0].score);
  scoreEls[1].textContent = Math.max(0, state.players[1].score);
  // staged chips & values
  for(let p=0;p<2;p++){
    // chips
    const chips = chipsEls[p].querySelectorAll('.dart-chip');
    for(let i=0;i<3;i++){
      const d = state.staged[p][i];
      const chip = chips[i];
      if(d){
        chip.textContent = d.label;
        chip.classList.remove('empty');
        chip.style.background = chipColor(d);
      } else {
        chip.textContent = 'D'+(i+1);
        chip.classList.add('empty');
        chip.style.background = '';
      }
    }
    // values line
    const vals = state.staged[p].map(d => d ? d.val : '-').join(' | ');
    valsEls[p].textContent = vals;
    // 3DA display (active shown red, inactive grey)
    const da = compute3DAFor(p);
    avgEls[p].textContent = '3DA: ' + da.toFixed(2);
    avgEls[p].className = 'threeDA' + (state.current === p ? '' : ' inactive');
  }
  // active player highlight
  playerEls.forEach((pe, idx) => {
    pe.classList.toggle('active', idx === state.current);
  });
  save();
}

/* small helper for chip color */
function chipColor(d){
  if(!d) return '';
  if(d.label === 'Bull') return 'linear-gradient(90deg,#ffd700,#ffec8a)';
  if(d.mult === 3) return '#ffe6e6'; // treble light red
  if(d.mult === 2) return '#def3ff'; // double light blue
  return '#f7fbff';
}

/* floating confirmation label */
function showFloat(text){
  floatLabel.textContent = text;
  floatLabel.classList.add('show');
  setTimeout(()=> floatLabel.classList.remove('show'), 600);
}

/* ---------- Input handlers (grid) ---------- */
document.getElementById('grid').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  if(modal.style.display === 'flex') return; // paused when stats open
  const action = btn.dataset.action;
  if(action === 'double'){ state.pendingMultiplier = 2; toastShowTemp('Double selected'); return; }
  if(action === 'treble'){ state.pendingMultiplier = 3; toastShowTemp('Treble selected'); return; }
  if(action === '25'){ // single 25
    pushDart({label:'25', val:25, mult:1, base:25});
    return;
  }
  if(action === 'bull'){
    pushDart({label:'Bull', val:50, mult:2, base:25});
    return;
  }
  if(action === 'noscore'){
    pushDart({label:'0', val:0, mult:0, base:0});
    return;
  }
  const num = btn.dataset.num ? parseInt(btn.dataset.num,10) : null;
  if(num !== null){
    let mult = state.pendingMultiplier || 1;
    const label = (mult === 1) ? String(num) : (mult === 2 ? 'D'+num : 'T'+num);
    const val = num * mult;
    pushDart({label, val, mult, base:num});
    state.pendingMultiplier = null;
    return;
  }
});

/* helper to show a tiny toast for mode select */
function toastShowTemp(msg){
  toastShow(msg, 700);
}

/* push dart into staged array (for active player) */
function pushDart(d){
  const p = state.current;
  if(state.staged[p].length >= 3){
    toastShow('Max 3 darts â€” submit or undo', 1200);
    return;
  }
  // store startScore for bust revert if first dart
  if(state.staged[p].length === 0 && state.players[p].score !== null){
    state.turnStart = state.players[p].score;
  }
  // apply to staged and update score *temporarily*
  state.staged[p].push(d);
  state.players[p].score -= d.val;
  showFloat(`${d.label} â†’ ${d.val}`);
  render();
}

/* tapping a dart chip to edit a staged dart */
document.getElementById('chips-home').addEventListener('click',(ev)=>onEditChip(ev,0));
document.getElementById('chips-away').addEventListener('click',(ev)=>onEditChip(ev,1));
function onEditChip(ev, playerIndex){
  const btn = ev.target.closest('.dart-chip');
  if(!btn) return;
  const idx = parseInt(btn.dataset.index,10);
  if(!Number.isFinite(idx)) return;
  // if slot not present, hint
  if(!state.staged[playerIndex][idx]) { toastShow('No dart in this slot â€” tap a number'); return; }
  // open edit: revert that dart immediate effect and set editingIndex
  // revert player's score and dartsThrown
  const d = state.staged[playerIndex][idx];
  state.players[playerIndex].score += d.val;
  // mark editing and set current to that player so next entry replaces it
  state.staged[playerIndex].editingIndex = idx;
  // ensure current points to that player for convenience
  state.current = playerIndex;
  render();
  toastShow('Editing dart ' + (idx+1));
}

/* Undo staged last dart */
el('undo-dart')?.addEventListener('click',()=>{
  const p = state.current;
  if(state.staged[p].length === 0){ toastShow('No staged darts'); return; }
  const removed = state.staged[p].pop();
  state.players[p].score += removed.val;
  render();
});

/* Undo this player's entire staged turn */
el('undo-turn')?.addEventListener('click',()=>{
  const p = state.current;
  if(state.staged[p].length === 0){ toastShow('Nothing to undo'); return; }
  // restore start score
  if(typeof state.turnStart !== 'undefined') state.players[p].score = state.turnStart;
  state.staged[p] = [];
  delete state.staged[p].editingIndex;
  render();
});

/* Undo last player's last confirmed turn and switch back */
el('undo-last')?.addEventListener('click',()=>{
  if(state.history.length === 0){ toastShow('No confirmed turns'); return; }
  // find last confirmed turn (pop)
  const last = state.history.pop();
  // revert player's score and reduce dartsThrown (approx)
  state.players[last.player].score = last.startScore;
  // restore staged arrays
  state.current = last.player;
  // if a leg was won revert leg flags (we're not implementing legs in full here)
  render();
  toastShow('Last player turn undone');
  save();
});

/* Submit Turn (finalize staged darts) */
el('submit')?.addEventListener('click',()=>{
  const p = state.current;
  if(state.staged[p].length === 0){ toastShow('Enter at least one dart'); return; }
  // compute startScore (turnStart fallback)
  const startScore = (typeof state.turnStart === 'number') ? state.turnStart : (state.players[p].score + state.staged[p].reduce((s,d)=>s+d.val,0));
  const turnTotal = state.staged[p].reduce((s,d)=>s+d.val,0);
  const final = startScore - turnTotal;

  // bust rules
  let bust=false, finished=false;
  if(final < 0) bust = true;
  else if(final === 1) bust = true;
  else if(final === 0){
    const lastD = state.staged[p][state.staged[p].length-1];
    const isDoubleBull = lastD && lastD.label === 'Bull' && state.doubleOut;
    const isDouble = lastD && lastD.mult === 2;
    if(state.doubleOut){
      if(isDouble || isDoubleBull) finished = true;
      else bust = true;
    } else {
      finished = true;
    }
  }

  if(bust){
    // record bust in history (darts count but points not applied)
    state.history.push({ player:p, startScore, darts:state.staged[p].slice(), newScore:startScore, turnTotal:0, bust:true, legWon:false, legIndex:computeCurrentLegIndex() });
    render(); save();
    // show bust: keep values visible for 2s then revert to start and switch
    showFloat('BUST!');
    setTimeout(()=>{
      state.players[p].score = startScore; // revert
      state.staged[p] = [];
      delete state.turnStart;
      render();
      // switch player
      state.current = 1 - p;
      render();
    }, 2000);
    return;
  }

  if(finished){
    // record finishing leg (we'll not auto-manage full match legs here but record)
    state.history.push({ player:p, startScore, darts:state.staged[p].slice(), newScore:0, turnTotal, bust:false, legWon:true, legIndex:computeCurrentLegIndex() });
    // update highest checkout
    if(turnTotal > state.players[p].highestCheckout) state.players[p].highestCheckout = turnTotal;
    render(); save();
    showFloat('LEG WON!');
    // reset scores for both to START for new leg (simple approach)
    state.players[0].score = START;
    state.players[1].score = START;
    state.staged[p] = [];
    delete state.turnStart;
    // keep same player starter logic could alternate here
    render();
    return;
  }

  // normal apply
  state.history.push({ player:p, startScore, darts:state.staged[p].slice(), newScore:final, turnTotal, bust:false, legWon:false, legIndex:computeCurrentLegIndex() });
  state.players[p].score = final;
  // push confirmed darts into "all darts" for averages
  // (we rely on history for averages)
  state.staged[p] = [];
  delete state.turnStart;
  render();
  // switch player
  state.current = 1 - p;
  render();
  save();
});

/* stats modal open - pause gameplay */
statsBtn.addEventListener('click', ()=>{
  // build stats content (current leg)
  const home3 = compute3DAFor(0).toFixed(2);
  const away3 = compute3DAFor(1).toFixed(2);
  const homeFirst9 = computeFirst9(0).toFixed(1);
  const awayFirst9 = computeFirst9(1).toFixed(1);
  const high0 = findHighTurn(0);
  const high1 = findHighTurn(1);
  statsContent.innerHTML = `
    <strong>Home</strong> 3DA: ${home3} â€¢ First9: ${homeFirst9} â€¢ High turn: ${high0}<br/><br/>
    <strong>Away</strong> 3DA: ${away3} â€¢ First9: ${awayFirst9} â€¢ High turn: ${high1}
  `;
  // show modal and disable grid interactions by cover
  modal.style.display = 'flex';
});
closeModal.addEventListener('click', ()=>{ modal.style.display='none'; });

function findHighTurn(playerIndex){
  let best = 0;
  state.history.forEach(h => { if(h.player === playerIndex && !h.bust && h.turnTotal > best) best = h.turnTotal; });
  return best;
}

/* small helpers */
function toastShow(txt, ms=1000){ toast.textContent=txt; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), ms); }

/* rendering initial */
render();

/* expose for debugging */
window._legion = { state, save, render };
</script>
</body>
</html>